{% extends "base.njk" %}
{% block title %}{{ channel.aaa }}{% endblock %}

{% block body %}
<div class="row" id="danmaku-channel">
  <div class="col-md-8 col-md-offset-2">
    <h2>{{ channel.desc }}</h2>
    {# {% if not channel.is_open and not passwd %}
    <form class="form-inline" role="form" @submit="set_passwd" v-show="!pub_passwd">
      <div class="form-group">
        <input type="password" class="form-control" v-model="pub_passwd_buf" placeholder="{{_('Channel Password')}}">
        <div class="btn btn-success" @click="set_passwd">{{_('Save')}}</div>
      </div>
    </form>
    {% endif %} #}

    {% raw %}
    <div v-show="error_msg">
      <div class='alert alert-danger'>{{error_msg}}</div>
    </div>
    {% endraw %}

    {# QR code #}
    {# <div class="dropdown">
      <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
        <span class="glyphicon glyphicon-qrcode"></span>
        <span class="caret"></span>
      </button>
      <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
        <li>
          <div id="qrcode"></div>
          <script type="text/javascript">new QRCode(document.getElementById("qrcode"), document.URL);</script>
        </li>
      </ul>
    </div>
    <div id="token">{{token}}</div> #}

    {# danmaku form #}
    <form @submit="post_danmaku">
      <div class="form-group" id="position-selection">
        <label for="position">弹幕位置</label>
        <div>
          <label class="radio-inline">
            <input type="radio" name="position" value="fly" v-model="position" checked> 飞过
          </label>
          <label class="radio-inline">
            <input type="radio" name="position" value="top" v-model="position"> 顶部
          </label>
          <label class="radio-inline">
            <input type="radio" name="position" value="bottom" v-model="position"> 底部
          </label>
        </div>
      </div>

      <div class="form-group" id="color-selection">
        <label for="style">弹幕颜色}</label>
        <div>
          <label class="radio-inline">
            <input type="radio" name="style" value="white" v-model="color" checked>
            <span class="label label-white">白色</span>
          </label>
          <label class="radio-inline">
            <input type="radio" name="style" value="blue" v-model="color">
            <span class="label label-blue">蓝色</span>
          </label>
          <label class="radio-inline">
            <input type="radio" name="style" value="red" v-model="color">
            <span class="label label-red">红色</span>
          </label>
          <label class="radio-inline">
            <input type="radio" name="style" value="yellow" v-model="color">
            <span class="label label-yellow">黄色</span>
          </label>
          <label class="radio-inline">
            <input type="radio" name="style" value="cyan" v-model="color">
            <span class="label label-cyan">青色</span>
          </label>
          <label class="radio-inline">
            <input type="radio" name="style" value="green" v-model="color">
            <span class="label label-green">绿色</span>
          </label>
          <label class="radio-inline">
            <input type="radio" name="style" value="purple" v-model="color">
            <span class="label label-purple">紫色</span>
          </label>
          <label class="radio-inline">
            <input type="radio" name="style" value="black" v-model="color">
            <span class="label label-black">黑色</span>
          </label>
        </div>
      </div>

      <div class="form-group">
        <label for="danmaku">弹幕内容</label>
        <input type="text" class="form-control" name="content" autocomplete="off" v-model="content" placeholder="在这里发射弹幕">
      </div>

      <input type="submit" class="btn btn-success" value="发射" :disabled="disabled" />
    </form>
  </div>
</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"></script>
<script type="text/javascript">

$(document).ready(function() {
  var channelVue = new Vue({
    el: "#danmaku-channel",
    data: {
      content: "",
      position: "fly",
      color: "white",
      error_msg: "",
      pub_passwd_buf: "",
      pub_passwd: "{{passwd}}",
      // token: $("#token").remove().text(),
      disabled: false
    },
    methods: {
      post_danmaku: function(ev){
        ev.preventDefault();
        this.disabled = true;
        var data = JSON.stringify({
          content: this.content,
          color: this.color,
          position: this.position
        });
        $.ajax({
          type: "POST",
          dataType: "json",
          headers: {
            "Content-Type": "application/json",
            // "X-GDANMAKU-AUTH-KEY": this.pub_passwd,
            // "X-GDANMAKU-TOKEN": "WEB:" + this.token
          },
          url: "{{ apiCreateDanmaaku }}",
          data: data,
          success: function(data) {
            // channelVue.token = data.token;
            channelVue.content = "";
            channelVue.disabled = false;
            console.log(data.status);
          },
          statusCode: {
            403: function() {
              channelVue.show_error("Wrong password, refresh the page to reset!");
            },
            428: function() {
              channelVue.show_error("You are operating too fast, calm down and refresh the page!");
            },
            400: function() {
              channelVue.show_error("Invalid request, refresh the page and retry!");
            }
          }
        });
      }, // post_danmaku
      set_passwd: function(ev) {
        ev.preventDefault();
        this.pub_passwd = this.pub_passwd_buf;
      },
      show_error: function(msg) {
        this.error_msg = msg;
      },
    }
  });

});

</script>
{% endblock %}

{% block css %}
<style type="text/css">
body {
  padding-top: 40px;
}
#qrcode {
  padding: 20px;
}
.label.label-white {
  background: #fff;
  border: 1px solid #666;
  color: #666;
}
.label.label-blue {
  background-color: #145fc6;
}
.label.label-red {
  background-color: #e72200;
}
.label.label-green {
  background-color: #04ca00;
}
.label.label-cyan {
  background-color: #0ff;
  color: #666;
}
.label.label-yellow {
  background-color: #fffa00;
  color: #666;
}
.label.label-purple {
  background-color: #808;
}
.label.label-black {
  background-color: #000;
}
</style>
{% endblock %}
